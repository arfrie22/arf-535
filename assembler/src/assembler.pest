label_arg = ${ ASCII_ALPHA ~ (ASCII_ALPHANUMERIC | "_" )*  }
digit_number = ${ ASCII_DIGIT+ }
hex_number = ${ "0x" ~ ASCII_HEX_DIGIT+ }
binary_number = ${ "0b" ~ ASCII_BIN_DIGIT+ }
number = ${ hex_number | binary_number | digit_number }
signed_number = ${ ("+" | "-" )? ~ number }
register = ${ ^"R" ~ ("31" | "30" | "29" | "28" | "27" | "26" | "25" | "24" | "23" | "22" | "21" | "20" | "19" | "18" | "17" | "16" | "15" | "14" | "13" | "12" | "11" | "10" | "9" | "8" | "7" | "6" | "5" | "4" | "3" | "2" | "1" | "0") | (^"A" | ^"D") ~ ('1'..'4') | ^"PC" | ^"LR" | ^"ST" | ^"SP" }
f_register = ${ ^"F" ~ ("31" | "30" | "29" | "28" | "27" | "26" | "25" | "24" | "23" | "22" | "21" | "20" | "19" | "18" | "17" | "16" | "15" | "14" | "13" | "12" | "11" | "10" | "9" | "8" | "7" | "6" | "5" | "4" | "3" | "2" | "1" | "0") }
timer = ${ ^"T" ~ ("31" | "30" | "29" | "28" | "27" | "26" | "25" | "24" | "23" | "22" | "21" | "20" | "19" | "18" | "17" | "16" | "15" | "14" | "13" | "12" | "11" | "10" | "9" | "8" | "7" | "6" | "5" | "4" | "3" | "2" | "1" | "0") }
empty = { "" }
p_address = ${ "p" ~ number | "p:" ~ label_arg }
p_address_implicit = ${ "p"? ~ number | "p:"? ~ label_arg }
d_address = ${ "d" ~ number | "d:" ~ label_arg }
d_address_implicit = ${ "d"? ~ number | "d:"? ~ label_arg }
data_shift_register = _{ "d"? ~ "[" ~ WHITESPACE* ~ register ~ (WHITESPACE* ~ "+" ~ WHITESPACE* ~ register ~ ((WHITESPACE* ~ "<<" ~ WHITESPACE* ~ number) | empty)) ~ WHITESPACE* ~ "]" }
data_shift_imm = _{ "d"? ~ "[" ~ WHITESPACE* ~ register ~ ((WHITESPACE* ~ "+" ~ WHITESPACE* ~ number ~ ((WHITESPACE* ~ "<<" ~ WHITESPACE* ~ number) | empty)) | empty ~ empty) ~ WHITESPACE* ~ "]" }
prog_shift_register = _{ "p" ~ "[" ~ WHITESPACE* ~ register ~ (WHITESPACE* ~ "+" ~ WHITESPACE* ~ register ~ ((WHITESPACE* ~ "<<" ~ WHITESPACE* ~ number) | empty)) ~ WHITESPACE* ~ "]" }
prog_shift_imm = _{ "p" ~ "[" ~ WHITESPACE* ~ register ~ ((WHITESPACE* ~ "+" ~ WHITESPACE* ~ number ~ ((WHITESPACE* ~ "<<" ~ WHITESPACE* ~ number) | empty)) | empty ~ empty) ~ WHITESPACE* ~ "]" }
condition = ${ (^"NVR" | ^"EQ" | ^"GT" | ^"LT" | ^"GE" | ^"LE" | ^"OVRF" | ^"UNDF" | ^"DIVZ" | ^"EVEN" | ^"FINF" | ^"FZ" | ^"FNAN" | ^"FPOS")? }
condition_bit = ${ (^"C")? }
link_bit = ${ (^"R")? }
instruction_TRAP_00 = ${ ^"TRAP" }
instruction_PUSH_01 = ${ ^"PUSH" ~ WHITESPACE+ ~ register }
instruction_PUSH_02 = ${ ^"PUSH" ~ WHITESPACE+ ~ f_register }
instruction_POP_03 = ${ ^"POP" ~ WHITESPACE+ ~ register }
instruction_POP_04 = ${ ^"POP" ~ WHITESPACE+ ~ f_register }
instruction_SWP_05 = ${ ^"SWP" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ f_register }
instruction_STALL_06 = ${ ^"STALL" ~ WHITESPACE+ ~ number }
instruction_STALL_07 = ${ ^"STALL" ~ WHITESPACE+ ~ register }
instruction_B_20 = ${ ^"B" ~ link_bit ~ condition ~ WHITESPACE+ ~ register }
instruction_B_21 = ${ ^"B" ~ link_bit ~ condition ~ WHITESPACE+ ~ data_shift_imm }
instruction_B_22 = ${ ^"B" ~ link_bit ~ condition ~ WHITESPACE+ ~ data_shift_register }
instruction_BR_23 = ${ ^"BR" ~ link_bit ~ condition ~ WHITESPACE+ ~ register }
instruction_B_24 = ${ ^"B" ~ link_bit ~ condition ~ WHITESPACE+ ~ p_address }
instruction_BO_25 = ${ ^"BO" ~ link_bit ~ condition ~ WHITESPACE+ ~ signed_number }
instruction_LDL_40 = ${ ^"LDL" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ number }
instruction_LDH_41 = ${ ^"LDH" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ number }
instruction_SWP_42 = ${ ^"SWP" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_LDR_43 = ${ ^"LDR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_LDR_44 = ${ ^"LDR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ data_shift_imm }
instruction_LDR_45 = ${ ^"LDR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ data_shift_register }
instruction_LDR_46 = ${ ^"LDR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ prog_shift_imm }
instruction_LDR_47 = ${ ^"LDR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ prog_shift_register }
instruction_STR_48 = ${ ^"STR" ~ WHITESPACE+ ~ data_shift_imm ~ WHITESPACE+ ~ register }
instruction_STR_49 = ${ ^"STR" ~ WHITESPACE+ ~ data_shift_register ~ WHITESPACE+ ~ register }
instruction_STR_4a = ${ ^"STR" ~ WHITESPACE+ ~ prog_shift_imm ~ WHITESPACE+ ~ register }
instruction_STR_4b = ${ ^"STR" ~ WHITESPACE+ ~ prog_shift_register ~ WHITESPACE+ ~ register }
instruction_LDR_4c = ${ ^"LDR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ d_address }
instruction_LDR_4d = ${ ^"LDR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ p_address }
instruction_STR_4e = ${ ^"STR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ d_address }
instruction_STR_4f = ${ ^"STR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ p_address }
instruction_ZEX_50 = ${ ^"ZEX" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ number }
instruction_SEX_51 = ${ ^"SEX" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ number }
instruction_LDL_60 = ${ ^"LDL" ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ number }
instruction_LDH_61 = ${ ^"LDH" ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ number }
instruction_SWP_62 = ${ ^"SWP" ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ f_register }
instruction_LDR_63 = ${ ^"LDR" ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ f_register }
instruction_LDR_64 = ${ ^"LDR" ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ data_shift_imm }
instruction_LDR_65 = ${ ^"LDR" ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ data_shift_register }
instruction_STR_66 = ${ ^"STR" ~ WHITESPACE+ ~ data_shift_imm ~ WHITESPACE+ ~ f_register }
instruction_STR_67 = ${ ^"STR" ~ WHITESPACE+ ~ data_shift_register ~ WHITESPACE+ ~ f_register }
instruction_LDR_68 = ${ ^"LDR" ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ d_address }
instruction_STR_69 = ${ ^"STR" ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ d_address }
instruction_CMP_80 = ${ ^"CMP" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_CMP_81 = ${ ^"CMP" ~ WHITESPACE+ ~ register }
instruction_INC_82 = ${ ^"INC" ~ condition_bit ~ WHITESPACE+ ~ register }
instruction_DEC_83 = ${ ^"DEC" ~ condition_bit ~ WHITESPACE+ ~ register }
instruction_ADD_84 = ${ ^"ADD" ~ condition_bit ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_SUB_85 = ${ ^"SUB" ~ condition_bit ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_MUL_86 = ${ ^"MUL" ~ condition_bit ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_DIV_87 = ${ ^"DIV" ~ condition_bit ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_MOD_88 = ${ ^"MOD" ~ condition_bit ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_ADDS_89 = ${ ^"ADDS" ~ condition_bit ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_SUBS_8a = ${ ^"SUBS" ~ condition_bit ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_MULS_8b = ${ ^"MULS" ~ condition_bit ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_DIVS_8c = ${ ^"DIVS" ~ condition_bit ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_MODS_8d = ${ ^"MODS" ~ condition_bit ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_AND_8e = ${ ^"AND" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_OR_8f = ${ ^"OR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_NOT_90 = ${ ^"NOT" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_XOR_91 = ${ ^"XOR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_LSL_92 = ${ ^"LSL" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ number }
instruction_LSR_93 = ${ ^"LSR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ number }
instruction_ASL_94 = ${ ^"ASL" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ number }
instruction_ASR_95 = ${ ^"ASR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ number }
instruction_RTR_96 = ${ ^"RTR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ number }
instruction_LSL_97 = ${ ^"LSL" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_LSR_98 = ${ ^"LSR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_ASL_99 = ${ ^"ASL" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_ASR_9a = ${ ^"ASR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_RTR_9b = ${ ^"RTR" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_MUS_9c = ${ ^"MUS" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_MSU_9d = ${ ^"MSU" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ register }
instruction_CMP_a0 = ${ ^"CMP" ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ f_register }
instruction_CMP_a1 = ${ ^"CMP" ~ WHITESPACE+ ~ f_register }
instruction_ADD_a2 = ${ ^"ADD" ~ condition_bit ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ f_register }
instruction_SUB_a3 = ${ ^"SUB" ~ condition_bit ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ f_register }
instruction_MUL_a4 = ${ ^"MUL" ~ condition_bit ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ f_register }
instruction_DIV_a5 = ${ ^"DIV" ~ condition_bit ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ f_register }
instruction_CST_a6 = ${ ^"CST" ~ condition_bit ~ WHITESPACE+ ~ f_register ~ WHITESPACE+ ~ register }
instruction_CST_a7 = ${ ^"CST" ~ condition_bit ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ f_register }
instruction_SETT_c0 = ${ ^"SETT" ~ WHITESPACE+ ~ timer ~ WHITESPACE+ ~ register }
instruction_GETT_c1 = ${ ^"GETT" ~ WHITESPACE+ ~ register ~ WHITESPACE+ ~ timer }
instruction_CHKT_c2 = ${ ^"CHKT" ~ WHITESPACE+ ~ timer }
instruction_CLRT_c3 = ${ ^"CLRT" ~ WHITESPACE+ ~ timer }
comment = _{ ";" ~ ('!'..'~' | WHITESPACE)* }
label = _{label_arg ~ ":"}
instruction = _{ instruction_TRAP_00 | instruction_PUSH_01 | instruction_PUSH_02 | instruction_POP_03 | instruction_POP_04 | instruction_SWP_05 | instruction_STALL_06 | instruction_STALL_07 | instruction_B_20 | instruction_B_21 | instruction_B_22 | instruction_BR_23 | instruction_B_24 | instruction_BO_25 | instruction_LDL_40 | instruction_LDH_41 | instruction_SWP_42 | instruction_LDR_43 | instruction_LDR_44 | instruction_LDR_45 | instruction_LDR_46 | instruction_LDR_47 | instruction_STR_48 | instruction_STR_49 | instruction_STR_4a | instruction_STR_4b | instruction_LDR_4c | instruction_LDR_4d | instruction_STR_4e | instruction_STR_4f | instruction_ZEX_50 | instruction_SEX_51 | instruction_LDL_60 | instruction_LDH_61 | instruction_SWP_62 | instruction_LDR_63 | instruction_LDR_64 | instruction_LDR_65 | instruction_STR_66 | instruction_STR_67 | instruction_LDR_68 | instruction_STR_69 | instruction_CMP_80 | instruction_CMP_81 | instruction_INC_82 | instruction_DEC_83 | instruction_ADD_84 | instruction_SUB_85 | instruction_MUL_86 | instruction_DIV_87 | instruction_MOD_88 | instruction_ADDS_89 | instruction_SUBS_8a | instruction_MULS_8b | instruction_DIVS_8c | instruction_MODS_8d | instruction_AND_8e | instruction_OR_8f | instruction_NOT_90 | instruction_XOR_91 | instruction_LSL_92 | instruction_LSR_93 | instruction_ASL_94 | instruction_ASR_95 | instruction_RTR_96 | instruction_LSL_97 | instruction_LSR_98 | instruction_ASL_99 | instruction_ASR_9a | instruction_RTR_9b | instruction_MUS_9c | instruction_MSU_9d | instruction_CMP_a0 | instruction_CMP_a1 | instruction_ADD_a2 | instruction_SUB_a3 | instruction_MUL_a4 | instruction_DIV_a5 | instruction_CST_a6 | instruction_CST_a7 | instruction_SETT_c0 | instruction_GETT_c1 | instruction_CHKT_c2 | instruction_CLRT_c3 }
value = _{ instruction | label | comment }
prog_line = _{ WHITESPACE* ~ value ~ WHITESPACE* }
prog = ${ ".prog" ~ ((WHITESPACE* ~ NEWLINE)+ ~ prog_line)+ }
data_value = ${(number | signed_number) ~ "#" ~ number}
data_line = ${WHITESPACE* ~ label_arg ~ (WHITESPACE+ ~ data_value)+ ~ WHITESPACE*}
data = ${ ".data" ~ ((WHITESPACE* ~ NEWLINE)+ ~ (data_line | comment))* }
file = _{ SOI ~ (WHITESPACE | NEWLINE)* ~ prog ~ (WHITESPACE | NEWLINE)* ~ data? ~ (WHITESPACE | NEWLINE)* ~ EOI }
WHITESPACE = _{" " | "\t"}
